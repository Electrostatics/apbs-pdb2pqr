---
language: python

python:
  - 3.6
#  - 3.7

jobs:
  include:
    - name: "Generic Python 3.6 on Windows 10"
      ## https://docs.travis-ci.com/user/reference/windows/#how-do-i-use-msys2
      os: windows
      language: shell
      before_install:
        - |
            case $TRAVIS_OS_NAME in
              windows)
                [[ ! -f C:/tools/msys64/msys2_shell.cmd ]] && rm -rf C:/tools/msys64
                choco uninstall -y mingw
                choco upgrade --no-progress -y msys2
                export msys2='cmd //C RefreshEnv.cmd '
                export msys2+='& set MSYS=winsymlinks:nativestrict '
                export msys2+='& C:\\tools\\msys64\\msys2_shell.cmd -defterm -no-start'
                export mingw64="$msys2 -mingw64 -full-path -here -c "\"\$@"\" --"
                export msys2+=" -msys2 -c "\"\$@"\" --"
                $msys2 pacman --sync --noconfirm --needed mingw-w64-x86_64-toolchain
                ## Install more MSYS2 packages from https://packages.msys2.org/base here
                $msys2 pacman -S --noconfirm --needed base
                $msys2 pacman -S --noconfirm --needed base-devel
                $msys2 pacman -S --noconfirm --needed cmake-3.13
                $msys2 pacman -S --noconfirm --needed development
                $msys2 pacman -S --noconfirm --needed compression
                $msys2 pacman -S --noconfirm --needed git
                $msys2 pacman -S --noconfirm --needed libraries
                $msys2 pacman -S --noconfirm --needed msys2-devel
                $msys2 pacman -S --noconfirm --needed make
                $msys2 pacman -S --noconfirm --needed python3.7
                $msys2 pacman -S --noconfirm --needed python3-pip
                $msys2 pacman -S --noconfirm --needed swig
                taskkill //IM gpg-agent.exe //F  # https://travis-ci.community/t/4967
                export PATH=/C/tools/msys64/bin/:/C/tools/msys64/mingw64/usr/bin:$PATH
                ## https://www.msys2.org/wiki/Porting/
                ## Don't use mingw32-make
                export MAKE=mingw32-make  # so that Autotools can find it
                echo IAMHERE
                echo PRINTENV
                printenv
                ;;
            esac
      before_cache:
        - |
            # https://unix.stackexchange.com/a/137322/107554
            $msys2 pacman --sync --clean --noconfirm
      cache:
        directories:
          - $HOME/AppData/Local/Temp/chocolatey
          - /C/tools/msys64
    #  - name: "Generic Python 3.6 on macOS"
    #    os: osx
    #    osx_image: xcode11.4
    #    language: shell
    #    before_install:
    #      - python3 --version
    #      - pip3 install -U pip
    #      - pip3 install -U pytest
    #      - pip3 install -U numpy
    #      - pip3 install -U virtualenv
    #    addons:
    #      homebrew:
    #        packages:
    #          - gcc@7
    #          - bison
    #          - flex
    #          - swig
    #          - readline
    #          - git-lfs
    #        update: true
    # - name: "Generic Python 3.X on Linux"
    #   os: linux
    #   dist: xenial
    #   addons:
    #     apt:
    #       sources:
    #         - ubuntu-toolchain-r-test
    #       packages:
    #         - build-essential
    #         - software-properties-common
    #         - gcc-6
    #         - g++-6
    #         - bison
    #         - flex
    #         - swig
    #         - libreadline-dev

# compiler:
#    - gcc
#    - clang

env:
  global:
    - TRAVIS_ALLOW_FAILURE=true
    - TEST_LIST='born geoflow actin-dimer-auto actin-dimer-parallel alkanes FKBP hca-bind ion-pmf ion-protein ionize pka-lig point-pmf solv protein-rna'
    # From https://codecov.io/gh/Electrostatics/apbs-pdb2pqr
    - CODECOV_TOKEN="e3a1e24c-5598-4f47-9353-7fa0ac57f98e"
    - CMAKE_OPTS=' -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON -DENABLE_GEOFLOW=ON -DENABLE_FETK=OFF -DENABLE_PYTHON=OFF -DBUILD_SHARED_LIBS=OFF -DCMAKE_C_FLAGS="-fPIC"'
    #  - CMAKE_OPTS=' -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON -DENABLE_GEOFLOW=ON  -DENABLE_BEM=ON  -DGET_MSMS=ON  -DENABLE_FETK=OFF -DENABLE_PBSAM=OFF -DENABLE_PBAM=OFF -DENABLE_PYTHON=OFF -DBUILD_SHARED_LIBS=OFF -DCMAKE_C_FLAGS="-fPIC"'
    #  - CMAKE_OPTS=' -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON -DENABLE_GEOFLOW=ON  -DENABLE_BEM=ON  -DGET_MSMS=ON  -DENABLE_FETK=ON  -DENABLE_PBSAM=OFF -DENABLE_PBAM=OFF -DENABLE_PYTHON=ON  -DBUILD_SHARED_LIBS=ON  -DCMAKE_C_FLAGS="-fPIC" -DBUILD_DOC=ON'
    #  - CMAKE_OPTS=' -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON -DENABLE_GEOFLOW=ON  -DENABLE_BEM=OFF -DGET_MSMS=OFF -DENABLE_FETK=ON  -DENABLE_PBSAM=OFF -DENABLE_PBAM=OFF -DENABLE_PYTHON=ON  -DBUILD_SHARED_LIBS=ON  -DCMAKE_C_FLAGS="-fPIC" -DBUILD_DOC=ON'

branches:
  only:
    - master

before_install:
  - python3 --version
  - pip3 install -U pip
  - pip3 install -U pytest
  - pip3 install -U numpy
  - pip3 install -U virtualenv
  - pip3 install -r pdb2pqr/requirements.txt

before_script:
  - |
      $msys2 echo "==================================== WHERE AM I ==================================== "
      $msys2 pwd
      # Make the install directory
      $msys2 mkdir -p $HOME/local
      $msys2 echo "ENV2"
      $msys2 env

      $msys2 echo "==================================== VERSIONS: ==================================== "
      $msys2 echo "==================================== PYTHON VERSION"
      case $TRAVIS_OS_NAME in
        windows)
          where python
          find /C/tools/msys64 -name pip3\*
          find /C/tools/msys64 -name swig\*
          find /C -name rpc.h
          find /C -name fcntl.h
          ;;
      esac
      $msys2 python -c "import sys; print(sys.version)"
      $msys2 echo "==================================== CMAKE VERSION"
      $msys2 cmake --version
      $msys2 echo "==================================== Gcc VERSION"
      export CC=gcc
      export CMAKE_C_COMPILER=gcc
      $msys2 gcc --version
      $msys2 echo "==================================== G++ VERSION"
      export CXX=g++
      export CMAKE_CXX_COMPILER=g++
      $msys2 g++ --version
      $msys2 echo "==================================== SWIG VERSION"
      $msys2 swig -version

      echo "==================================== Install Python requirements ==================================== "
      $msys2 pip3 install -U pip
      $msys2 pip3 install -U pytest
      $msys2 pip3 install -U virtualenv
      $msys2 pip3 install -U numpy
      $msys2 pip3 install -r pdb2pqr/requirements.txt

      #  Just build APBS for now
      $msys2 echo "==================================== PWD FOR TOP DIR ==================================== "
      $msys2 pwd

      $msys2 echo "==================================== Get External SubModules ==================================== "
      $msys2 git submodule init
      $msys2 git submodule update
      #mkdir build
      #cd build
      #cmake ..
      #make VERBOSE=1
      #cd ..

      $msys2 cd apbs
      $msys2 echo "==================================== PWD FOR APBS SRC ==================================== "
      $msys2 pwd
      $msys2 mkdir build
      $msys2 cd build
      $msys2 echo "==================================== BUILD DIR ==================================== "
      $msys2 pwd

      $msys2 echo "==================================== RUN CMAKE ==================================== "
      $msys2 pwd
      export CMAKE_C_STANDARD_INCLUDE_DIRECTORIES="/C/tools/msys64/opt/x86_64-w64-mingw32/"
      export CMAKE_CXX_STANDARD_INCLUDE_DIRECTORIES="/C/tools/msys64/opt/x86_64-w64-mingw32/"
      $msys2 cmake $CMAKE_OPTS -DCMAKE_INSTALL_PREFIX:PATH=$HOME/local .. || exit 1
      $msys2 echo "==================================== RAN CMAKE =================================== "

      $msys2 echo "==================================== RUN MAKE ==================================== "
      $msys2 pwd
      $msys2 make -j 1
      #make -j 1 install

script:
  - |
      #  Assume we are in the User's home directory where the top of the repository
      $msys2 echo "==================================== LOOK for APBS binary ==================================== "
      $msys2 pwd
      $msys2 echo find $HOME -type f -name apbs
      $msys2 find $HOME -type f -name apbs
      $msys2 echo find $HOME -type f -name libmaloc
      $msys2 find $HOME -type f -name libmaloc\*
      $msys2 echo cd ../tests
      $msys2 cd ../tests
      $msys2 echo pwd
      $msys2 pwd
      $msys2 echo ls
      $msys2 ls
      if [ -f /etc/os-release ]; then
        ldd $HOME/local/bin/apbs
      fi
      #  TODO: Total HACK since it should be using STATIC libraries
      export LD_LIBRARY_PATH="/home/travis/build/Electrostatics/apbs-pdb2pqr/apbs/build/fetk/lib"
      for name in `echo $TEST_LIST`
      do
        echo bash run_travis_test.sh $HOME/local/bin $name
        bash run_travis_test.sh $HOME/local/bin $name
      done

notifications:
  slack:
    on_success: always
    #  - electrostatics:U4cSeRAFGXl9vUqdg4WOubnc
