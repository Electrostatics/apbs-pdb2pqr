#!/bin/bash

if [[ $1 = "" ]]; then
    echo "Please use \"make test\" to run the tests."
    exit
fi


logfile=TESTRESULTS.log
nettime=0

input=( apbs ) 

results=( 1.830820736656E+01 8.906693911566E+00 5.909599752197E+00 4.430144912287E+00 )

# Initialize the results file

echo "# This file is automatically generated by test.sh." >> $logfile
echo "# INPUT NAME |  TEST RESULT | 1A | 2A | 3A | 4A | TIME" >> $logfile


# Initialize the fixed atom

echo "ATOM      1  I   ION     1      -3.000   0.000   0.000  1.00  0.00" \
     > mol1.pqr

# For each file in the directory, run APBS and get the value

for i in 0 
do
  echo "----------------------------------------"
  echo "Testing input file ${input[i]}.in"
  echo ""

  pass=PASSED
  starttime=`date +%s`

  # 1 Angstrom Distance

  echo "ATOM      1  I   ION     1      -2.000    0.000   0.000  1.00 0.00"\
     > mol2.pqr
  cat mol1.pqr mol2.pqr > complex.pqr
  $1 ${input[i]}.in > ${input[i]}.out 
  answer=`grep "Global net" ${input[i]}.out | awk '{print $5}'`
  sync

  a=$answer
  echo ""
  echo "Energy from 1 A distance: $answer"
  if [[ ${answer} != ${results[0]} ]]; then
      echo "   Expected result is ${results[0]}"
      pass=FAILED
  fi

  # 2 Angstrom Distance
  echo ""
  echo "ATOM      1  I   ION     1      -1.000    0.000   0.000  1.00 0.00"\
     > mol2.pqr
  cat mol1.pqr mol2.pqr > complex.pqr
  $1 ${input[i]}.in > ${input[i]}.out 
  answer=`grep "Global net" ${input[i]}.out | awk '{print $5}'`
  sync

  b=$answer
  echo ""
  echo "Energy from 2 A distance: $answer"
  if [[ ${answer} != ${results[1]} ]]; then
      echo "   Expected result is ${results[1]}"
      pass=FAILED
  fi

  # 3 Angstrom Distance
  echo ""
  echo "ATOM      1  I   ION     1       0.000    0.000   0.000  1.00 0.00"\
     > mol2.pqr
  cat mol1.pqr mol2.pqr > complex.pqr
  $1 ${input[i]}.in > ${input[i]}.out 
  answer=`grep "Global net" ${input[i]}.out | awk '{print $5}'`
  sync

  c=$answer
  echo ""
  echo "Energy from 3 A distance: $answer"
  if [[ ${answer} != ${results[2]} ]]; then
      echo "   Expected result is ${results[2]}"
      pass=FAILED
  fi

  # 4 Angstrom Distance
  echo ""
  echo "ATOM      1  I   ION     1       1.000    0.000   0.000  1.00 0.00"\
     > mol2.pqr
  cat mol1.pqr mol2.pqr > complex.pqr
  $1 ${input[i]}.in > ${input[i]}.out 
  answer=`grep "Global net" ${input[i]}.out | awk '{print $5}'`
  sync

  d=$answer
  echo ""
  echo "Energy from 4 A distance: $answer"
  if [[ ${answer} != ${results[3]} ]]; then
      echo "   Expected result is ${results[3]}"
      pass=FAILED
  fi
  
  if [[ $pass = "FAILED" ]]; then
      echo "*** FAILED ***"
  else
      pass=PASSED
      echo "*** PASSED ***"
  fi

 

  endtime=`date +%s`
  let elapsed=$endtime-$starttime
  let nettime=$nettime+$elapsed
  echo "Total elapsed time: $elapsed seconds"
  echo "----------------------------------------"

  # Put the results of all the tests in TEST-RESULTS.log

  echo "${input[i]} $pass $a $b $c $d  $elapsed" >> $logfile

done

echo "Test results have been logged to ${logfile}."
echo "Total time for this directory: ${nettime} seconds."
